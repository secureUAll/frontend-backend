{% extends "dashboard/base.html" %}

{% comment "About" %}

    This template renders workers list and for each a list of the machines associated.

    -- Context
    workers             workers.models.Worker[]                         A list of workers
    machinesAdded       Object {worker: name:str, machines: int, edited: int, disassociated: int}
                                                                        For success notification when added machines to worker.

{% endcomment %}

{% load static %}
{% load workers_filters %}

{% block meta %}
    <title>Secure(ua)ll | Workers</title>
{% endblock meta %}

{% block headerClass %}{% endblock headerClass %}

{% block header %}
    <div class="header text-center my-auto">
        <h2 class="title mb-0">Workers</h2>
    </div>
{% endblock header %}

{% block styles %}
    <link href="{% static 'assets/css/plugins/datatables.css' %}" rel="stylesheet" />
{% endblock styles %}

{% block content %}
    <!-- Row of Tables -->
    <div class="row" id="workers">
        {% for worker in workers %}
            <div class="col-lg-12 d-flex mx-auto" id="worker{{worker.id}}">
                <div class="card card-chart d-flex flex-column">
                    <div class="card-header d-flex">
                        <h4 class="card-title">
                            Worker
                            <a
                                data-pk="{{worker.id}}"
                                data-url="/workers/{{worker.id}}/"
                                id="editName_worker{{worker.id}}"
                                href="#"
                                class="workerTitle"
                                title="Click to edit"
                            >{{worker.name}}</a>
                            {% csrf_token %}
                            <i class="small text-primary now-ui-icons design-2_ruler-pencil" title="Click on text to edit"></i>
                        </h4>
                        {% if worker.machines.all %}
                        <div class="ml-auto my-auto d-flex flex-row">
                            <div class="dropdown mx-auto dropdown-free">
                                <button class="btn btn-sm btn-outline-primary" title="Add machines" data-toggle="dropdown"><i class="now-ui-icons ui-1_simple-add"></i></button>
                                <div class="dropdown-menu dropdown-menu-left">
                                    <a class="dropdown-item" href="/workers/{{worker.id}}/machines/add/batch">Batch mode</a>
                                    <a class="dropdown-item" href="/workers/{{worker.id}}/machines/add/range">IP Range</a>
                                </div>
                            </div>
                            <a href="/workers/{{worker.id}}/machines/edit" class="ml-2"><button class="btn btn-sm btn-outline-primary" title="Edit machines"><i class="now-ui-icons design-2_ruler-pencil"></i></button></a>
                            <a href="/workers/{{worker.id}}/logs" class="ml-2"><button class="btn btn-sm btn-outline-primary" title="Machine logs"><i class="now-ui-icons text_align-center"></i></button></a>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-body my-auto d-flex flex-column">
                        <!-- Worker data -->
                        <div class="d-flex col-12 p-0 text-secondary">
                            <dl class="col-6 p-0">
                                <dt>Name</dt>
                                <dd>{{worker.name}}</dd>
                                <dt>Failures</dt>
                                <dd>{{worker.failures}}</dd>
                            </dl>
                            <dl class="col-6 p-0">
                                <dt>Status</dt>
                                <dd>
                                    <span class="text-{{worker.get_status_display|color}}">{{worker.get_status_display}}</span>
                                </dd>
                                <dt>Machines</dt>
                                <dd>{{worker.machines.all|length}}</dd>
                            </dl>
                        </div>
                        <div class="d-flex col-12 p-0 text-secondary">
                            <dl class="dl-12">
                                <dt>Created</dt>
                                <dd>{{worker.created}}</dd>
                            </dl>
                        </div>
                        <!-- Machines table -->
                        {% if worker.machines.all %}
                            <div class="mt-3 d-flex flex-row">
                                <h5 class="mb-0">20 machines associated</h5>
                                <div class="dropdown ml-auto dropdown-free ml-auto">
                                    <button
                                        class="btn btn-outline-primary"
                                        data-toggle="collapse"
                                        data-target="#workerMachines{{worker.id}}"
                                        aria-expanded="false"
                                        aria-controls="workerMachines{{worker.id}}"
                                        id="workerMachines{{worker.id}}Collapse"
                                    >
                                        <i class="now-ui-icons tech_laptop mr-2"></i> See hosts
                                    </button>
                                </div>
                            </div>
                            <div
                                class="collapse"
                                aria-labelledby="workerMachines{{worker.id}}Collapse"
                                id="workerMachines{{worker.id}}"
                                data-parent="#workers"
                            >
                                <div class="table-responsive col-12 my-4">
                                    <table class="table table-discreet workersTable" id="table{{worker.id}}">
                                        <thead class=" text-primary">
                                            <th>Machine</th>
                                            <th>Location</th>
                                            <th>Scan level</th>
                                            <th>Risk</th>
                                            <th>Periodicity</th>
                                            <th>Next scan</th>
                                        </thead>
                                        <tbody>
                                                {% for machineworker in worker.machines.all|dictsort:"machine.nextScan" %}
                                                    {% with machine=machineworker.machine %}
                                                        <tr title="See machine page" onClick="window.location='/machines/{{machine.id}}'">
                                                            <td>{{machine}}</td>
                                                            <td>{% if machine.location %}{{machine.location}}{% endif %}</td>
                                                            <td><span class="badge p-2 bg-{{machine.scanLevel}}">{{machine.get_scanLevel_display}}</span></td>
                                                            <td>
                                                                {% if machine.risk %}
                                                                <span class="badge p-2 bg-{{machine.risk}}">{{machine.risk}}</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{machine.get_periodicity_display}}</td>
                                                            <td>{{machine.nextScan}}</td>
                                                        </tr>
                                                    {% endwith %}
                                                {% endfor %}

                                        </tbody>
                                    </table>
                                </div>
                        </div>
                        {% else %}
                            <div class="mt-3 d-flex flex-row">
                                <h5 class="text-warning">No machines associated!</h5>
                                <div class="dropdown ml-auto dropdown-free">
                                    <button
                                        class="btn btn-outline-warning"
                                        data-toggle="dropdown"
                                    >
                                        <i class="now-ui-icons ui-1_simple-add mr-2"></i> Add machines
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <a class="dropdown-item" href="/workers/{{worker.id}}/machines/add/batch">Batch mode</a>
                                        <a class="dropdown-item" href="/workers/{{worker.id}}/machines/add/range">IP Range</a>
                                    </div>
                                </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer mt-auto">
                        <div class="stats">
                            <i class="now-ui-icons arrows-1_refresh-69"></i> <span class="refresh-counter"></span>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

{% endblock content %}

{% block scripts %}
    <!-- Editable -->
    <script src="{% static 'assets/js/plugins/bootstrap-editable.min.js' %}"></script>
    <!-- Data Tables Script -->
    <script src="{% static 'assets/js/plugins/datatables.min.js' %}"></script>
    <!-- Custom JS -->
    <script src="{% static 'workers/workers.js' %}"></script>
    <script src="{% static 'assets/js/refresh.js' %}"></script>

    <script>
        {% if machinesWithoutWorker %}
            showNotification(
                "There are {{machinesWithoutWorker}} machines without a worker!",
                "To see the full list and associate them to a worker click <a class=\"text-white\" href=\"#\">here</a>.",
                "warning",
                "ui-2_settings-90"
            );
        {% endif %}
        {% if machinesAdded %}
            showNotification(
                "Changes applied to worker {{machinesAdded.worker}}!",
                "{{machinesAdded.machines}} machines where associated, {{machinesAdded.new}} new machine was created, {{machinesAdded.edited}} edited and {{machinesAdded.disassociated}} disassociated with success!",
                "success",
                "tech_laptop"
            );
        {% endif %}
    </script>
{% endblock scripts %}